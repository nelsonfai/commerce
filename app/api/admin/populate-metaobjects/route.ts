
// app/api/populate-country-flags/route.ts

/* 
import { NextResponse } from 'next/server';

const SHOP = process.env.SHOPIFY_STORE_DOMAIN
const ACCESS_TOKEN = process.env.SHOPIFY_ADMIN_API_TOKEN
const countries = [
    { name: "Algeria", flag: "ğŸ‡©ğŸ‡¿" },
    { name: "Angola", flag: "ğŸ‡¦ğŸ‡´" },
    { name: "Benin", flag: "ğŸ‡§ğŸ‡¯" },
    { name: "Botswana", flag: "ğŸ‡§ğŸ‡¼" },
    { name: "Burkina Faso", flag: "ğŸ‡§ğŸ‡«" },
    { name: "Burundi", flag: "ğŸ‡§ğŸ‡®" },
    { name: "Cabo Verde", flag: "ğŸ‡¨ğŸ‡»" },
    { name: "Cameroon", flag: "ğŸ‡¨ğŸ‡²" },
    { name: "Central African Republic", flag: "ğŸ‡¨ğŸ‡«" },
    { name: "Chad", flag: "ğŸ‡¹ğŸ‡©" },
    { name: "Comoros", flag: "ğŸ‡°ğŸ‡²" },
    { name: "Democratic Republic of the Congo", flag: "ğŸ‡¨ğŸ‡©" },
    { name: "Republic of the Congo", flag: "ğŸ‡¨ğŸ‡¬" },
    { name: "CÃ´te d'Ivoire", flag: "ğŸ‡¨ğŸ‡®" },
    { name: "Djibouti", flag: "ğŸ‡©ğŸ‡¯" },
    { name: "Egypt", flag: "ğŸ‡ªğŸ‡¬" },
    { name: "Equatorial Guinea", flag: "ğŸ‡¬ğŸ‡¶" },
    { name: "Eritrea", flag: "ğŸ‡ªğŸ‡·" },
    { name: "Eswatini", flag: "ğŸ‡¸ğŸ‡¿" },
    { name: "Ethiopia", flag: "ğŸ‡ªğŸ‡¹" },
    { name: "Gabon", flag: "ğŸ‡¬ğŸ‡¦" },
    { name: "Gambia", flag: "ğŸ‡¬ğŸ‡²" },
    { name: "Ghana", flag: "ğŸ‡¬ğŸ‡­" },
    { name: "Guinea", flag: "ğŸ‡¬ğŸ‡³" },
    { name: "Guinea-Bissau", flag: "ğŸ‡¬ğŸ‡¼" },
    { name: "Kenya", flag: "ğŸ‡°ğŸ‡ª" },
    { name: "Lesotho", flag: "ğŸ‡±ğŸ‡¸" },
    { name: "Liberia", flag: "ğŸ‡±ğŸ‡·" },
    { name: "Libya", flag: "ğŸ‡±ğŸ‡¾" },
    { name: "Madagascar", flag: "ğŸ‡²ğŸ‡¬" },
    { name: "Malawi", flag: "ğŸ‡²ğŸ‡¼" },
    { name: "Mali", flag: "ğŸ‡²ğŸ‡±" },
    { name: "Mauritania", flag: "ğŸ‡²ğŸ‡·" },
    { name: "Mauritius", flag: "ğŸ‡²ğŸ‡º" },
    { name: "Morocco", flag: "ğŸ‡²ğŸ‡¦" },
    { name: "Mozambique", flag: "ğŸ‡²ğŸ‡¿" },
    { name: "Namibia", flag: "ğŸ‡³ğŸ‡¦" },
    { name: "Niger", flag: "ğŸ‡³ğŸ‡ª" },
    { name: "Nigeria", flag: "ğŸ‡³ğŸ‡¬" },
    { name: "Rwanda", flag: "ğŸ‡·ğŸ‡¼" },
    { name: "Sao Tome and Principe", flag: "ğŸ‡¸ğŸ‡¹" },
    { name: "Senegal", flag: "ğŸ‡¸ğŸ‡³" },
    { name: "Seychelles", flag: "ğŸ‡¸ğŸ‡¨" },
    { name: "Sierra Leone", flag: "ğŸ‡¸ğŸ‡±" },
    { name: "Somalia", flag: "ğŸ‡¸ğŸ‡´" },
    { name: "South Africa", flag: "ğŸ‡¿ğŸ‡¦" },
    { name: "South Sudan", flag: "ğŸ‡¸ğŸ‡¸" },
    { name: "Sudan", flag: "ğŸ‡¸ğŸ‡©" },
    { name: "Tanzania", flag: "ğŸ‡¹ğŸ‡¿" },
    { name: "Togo", flag: "ğŸ‡¹ğŸ‡¬" },
    { name: "Tunisia", flag: "ğŸ‡¹ğŸ‡³" },
    { name: "Uganda", flag: "ğŸ‡ºğŸ‡¬" },
    { name: "Zambia", flag: "ğŸ‡¿ğŸ‡²" },
    { name: "Zimbabwe", flag: "ğŸ‡¿ğŸ‡¼" }
  ];
  

export async function GET() {
  const results = [];

  for (const country of countries) {
    const handle = country.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
    const createInput = {
      type: "country_flags",
      handle,
      fields: [
        { key: "name", value: country.name },
        { key: "flag", value: country.flag },
      ]
    };

    // 1. Create the Metaobject
    const createResponse = await fetch(`https://${SHOP}/admin/api/2024-04/graphql.json`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Access-Token': ACCESS_TOKEN,
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        query: `
          mutation CreateCountryFlag($input: MetaobjectCreateInput!) {
            metaobjectCreate(metaobject: $input) {
              metaobject {
                id
                handle
              }
              userErrors {
                field
                message
                code
              }
            }
          }
        `,
        variables: { input: createInput }
      })
    });

    const createJson = await createResponse.json();
    const createData = createJson.data?.metaobjectCreate;
    const createdMetaobject = createData?.metaobject;
    const createErrors = createData?.userErrors ?? createJson.errors;

    if (createErrors.length === 0 && createdMetaobject?.id) {
      // 2. Publish the Metaobject
      const publishResponse = await fetch(`https://${SHOP}/admin/api/2024-04/graphql.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Shopify-Access-Token': ACCESS_TOKEN,
          'Accept': 'application/json',
        },
        body: JSON.stringify({
          query: `
            mutation PublishMetaobject($id: ID!) {
              metaobjectPublish(id: $id) {
                metaobject {
                  id
                  isPublished
                }
                userErrors {
                  field
                  message
                }
              }
            }
          `,
          variables: {
            id: createdMetaobject.id
          }
        })
      });

      const publishJson = await publishResponse.json();
      const publishErrors = publishJson.data?.metaobjectPublish?.userErrors ?? publishJson.errors;

      results.push({
        country: country.name,
        success: publishErrors.length === 0,
        errors: publishErrors
      });
    } else {
      results.push({
        country: country.name,
        success: false,
        errors: createErrors
      });
    }
  }

  return NextResponse.json({
    created: results.filter(r => r.success),
    failed: results.filter(r => !r.success)
  });
}

*/





// app/api/publish-country-flags/route.ts
import { NextResponse } from 'next/server';

const SHOP = 'snacksafaritest.myshopify.com';
const ACCESS_TOKEN = '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';

const countries = [
    { name: "Algeria", flag: "ğŸ‡©ğŸ‡¿" },
    { name: "Angola", flag: "ğŸ‡¦ğŸ‡´" },
    { name: "Benin", flag: "ğŸ‡§ğŸ‡¯" },
    { name: "Botswana", flag: "ğŸ‡§ğŸ‡¼" },
    { name: "Burkina Faso", flag: "ğŸ‡§ğŸ‡«" },
    { name: "Burundi", flag: "ğŸ‡§ğŸ‡®" },
    { name: "Cabo Verde", flag: "ğŸ‡¨ğŸ‡»" },
    { name: "Cameroon", flag: "ğŸ‡¨ğŸ‡²" },
    { name: "Central African Republic", flag: "ğŸ‡¨ğŸ‡«" },
    { name: "Chad", flag: "ğŸ‡¹ğŸ‡©" },
    { name: "Comoros", flag: "ğŸ‡°ğŸ‡²" },
    { name: "Democratic Republic of the Congo", flag: "ğŸ‡¨ğŸ‡©" },
    { name: "Republic of the Congo", flag: "ğŸ‡¨ğŸ‡¬" },
    { name: "CÃ´te d'Ivoire", flag: "ğŸ‡¨ğŸ‡®" },
    { name: "Djibouti", flag: "ğŸ‡©ğŸ‡¯" },
    { name: "Egypt", flag: "ğŸ‡ªğŸ‡¬" },
    { name: "Equatorial Guinea", flag: "ğŸ‡¬ğŸ‡¶" },
    { name: "Eritrea", flag: "ğŸ‡ªğŸ‡·" },
    { name: "Eswatini", flag: "ğŸ‡¸ğŸ‡¿" },
    { name: "Ethiopia", flag: "ğŸ‡ªğŸ‡¹" },
    { name: "Gabon", flag: "ğŸ‡¬ğŸ‡¦" },
    { name: "Gambia", flag: "ğŸ‡¬ğŸ‡²" },
    { name: "Ghana", flag: "ğŸ‡¬ğŸ‡­" },
    { name: "Guinea", flag: "ğŸ‡¬ğŸ‡³" },
    { name: "Guinea-Bissau", flag: "ğŸ‡¬ğŸ‡¼" },
    { name: "Kenya", flag: "ğŸ‡°ğŸ‡ª" },
    { name: "Lesotho", flag: "ğŸ‡±ğŸ‡¸" },
    { name: "Liberia", flag: "ğŸ‡±ğŸ‡·" },
    { name: "Libya", flag: "ğŸ‡±ğŸ‡¾" },
    { name: "Madagascar", flag: "ğŸ‡²ğŸ‡¬" },
    { name: "Malawi", flag: "ğŸ‡²ğŸ‡¼" },
    { name: "Mali", flag: "ğŸ‡²ğŸ‡±" },
    { name: "Mauritania", flag: "ğŸ‡²ğŸ‡·" },
    { name: "Mauritius", flag: "ğŸ‡²ğŸ‡º" },
    { name: "Morocco", flag: "ğŸ‡²ğŸ‡¦" },
    { name: "Mozambique", flag: "ğŸ‡²ğŸ‡¿" },
    { name: "Namibia", flag: "ğŸ‡³ğŸ‡¦" },
    { name: "Niger", flag: "ğŸ‡³ğŸ‡ª" },
    { name: "Nigeria", flag: "ğŸ‡³ğŸ‡¬" },
    { name: "Rwanda", flag: "ğŸ‡·ğŸ‡¼" },
    { name: "Sao Tome and Principe", flag: "ğŸ‡¸ğŸ‡¹" },
    { name: "Senegal", flag: "ğŸ‡¸ğŸ‡³" },
    { name: "Seychelles", flag: "ğŸ‡¸ğŸ‡¨" },
    { name: "Sierra Leone", flag: "ğŸ‡¸ğŸ‡±" },
    { name: "Somalia", flag: "ğŸ‡¸ğŸ‡´" },
    { name: "South Africa", flag: "ğŸ‡¿ğŸ‡¦" },
    { name: "South Sudan", flag: "ğŸ‡¸ğŸ‡¸" },
    { name: "Sudan", flag: "ğŸ‡¸ğŸ‡©" },
    { name: "Tanzania", flag: "ğŸ‡¹ğŸ‡¿" },
    { name: "Togo", flag: "ğŸ‡¹ğŸ‡¬" },
    { name: "Tunisia", flag: "ğŸ‡¹ğŸ‡³" },
    { name: "Uganda", flag: "ğŸ‡ºğŸ‡¬" },
    { name: "Zambia", flag: "ğŸ‡¿ğŸ‡²" },
    { name: "Zimbabwe", flag: "ğŸ‡¿ğŸ‡¼" }
  ];

export async function GET() {
  const results = [];

  for (const country of countries) {
    const handle = country.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');

    // 1. Lookup existing metaobject by handle
    const lookupResponse = await fetch(`https://${SHOP}/admin/api/2024-04/graphql.json`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Access-Token': ACCESS_TOKEN,
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        query: `
          query GetMetaobjectId($handle: String!) {
            metaobjectByHandle(handle: $handle, type: "country_flags") {
              id
              isPublished
            }
          }
        `,
        variables: { handle }
      })
    });

    const lookupJson = await lookupResponse.json();
    const metaobject = lookupJson.data?.metaobjectByHandle;

    if (!metaobject) {
      results.push({
        country: country.name,
        success: false,
        errors: [{ message: 'Metaobject not found' }]
      });
      continue;
    }

    if (metaobject.isPublished) {
      results.push({
        country: country.name,
        success: true,
        note: 'Already published'
      });
      continue;
    }

    // 2. Publish it
    const publishResponse = await fetch(`https://${SHOP}/admin/api/2024-04/graphql.json`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Access-Token': ACCESS_TOKEN,
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        query: `
          mutation PublishMetaobject($id: ID!) {
            metaobjectPublish(id: $id) {
              metaobject {
                id
                isPublished
              }
              userErrors {
                field
                message
              }
            }
          }
        `,
        variables: {
          id: metaobject.id
        }
      })
    });

    const publishJson = await publishResponse.json();
    const publishErrors = publishJson.data?.metaobjectPublish?.userErrors ?? publishJson.errors;

    results.push({
      country: country.name,
      success: publishErrors.length === 0,
      errors: publishErrors
    });
  }

  return NextResponse.json({
    published: results.filter(r => r.success),
    failed: results.filter(r => !r.success)
  });
}
